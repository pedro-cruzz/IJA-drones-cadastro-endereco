{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h2 class="mb-4 text-primary"><i class="bi bi-pencil-square"></i> Edi√ß√£o Completa de Solicita√ß√£o (Admin)</h2>
        
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> Aten√ß√£o: Voc√™ est√° editando os dados originais da solicita√ß√£o. Use esta ferramenta com cautela.
        </div>

        <div class="card shadow-sm p-4">
            {# O formul√°rio envia o POST para a rota de edi√ß√£o completa #}
            <form action="{{ url_for('main.admin_editar_completo', id=pedido.id) }}" method="POST">
                
                <h4 class="mb-3 text-secondary">Detalhes do Pedido #{{ pedido.id }} - {{ pedido.autor.nome_uvis }}</h4>
                <hr>

                {# --- SE√á√ÉO 1: DATA E FOCO --- #}
                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 small fw-bold">1. Data e Tipo de Opera√ß√£o</legend>
                    <div class="row g-3">
                        
                        <div class="col-md-4">
                            <label for="data_agendamento" class="form-label small">Data da Visita</label>
                            {# Formato YYYY-MM-DD para input type="date" #}
                            <input type="date" class="form-control" id="data_agendamento" name="data_agendamento" 
                                value="{{ pedido.data_agendamento.isoformat() if pedido.data_agendamento else '' }}" required>
                        </div>

                        <div class="col-md-3">
                            <label for="hora_agendamento" class="form-label small">Hor√°rio</label>
                            {# Formato HH:MM para input type="time" #}
                            <input type="time" class="form-control" id="hora_agendamento" name="hora_agendamento" 
                                value="{{ pedido.hora_agendamento.strftime('%H:%M') if pedido.hora_agendamento else '' }}" required>
                        </div>
                        
                        <div class="col-md-5">
    <label for="foco" class="form-label small">Foco Principal da Opera√ß√£o</label>
    <select name="foco" id="foco" class="form-select" required>
        <option value="" disabled 
            {% if not pedido.foco %}selected{% endif %}>
            Selecione o tipo de foco...
        </option>
        
        {# Op√ß√µes do Foco #}
        {% set focos = [
            'Im√≥vel Abandonado',
            'Piscina / Caixa D\'√°gua',
            'Terreno Baldio',
            'Ponto Estrat√©gico (PE)'
        ] %}
        
        {% for foco_opcao in focos %}
        <option value="{{ foco_opcao }}" 
            {% if pedido.foco == foco_opcao %}selected{% endif %}>
            {{ foco_opcao }}
        </option>
        {% endfor %}
        
        {# Se o foco atual n√£o estiver na lista (ex: valor personalizado antigo), exibe ele como selecionado #}
        {% if pedido.foco and pedido.foco not in focos %}
        <option value="{{ pedido.foco }}" selected>
            {{ pedido.foco }} (Valor Personalizado Atual)
        </option>
        {% endif %}

    </select>
</div>
                    </div>
                </fieldset>

                {# --- SE√á√ÉO 2: DETALHES T√âCNICOS --- #}
                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 small fw-bold">2. Detalhes Operacionais e Risco</legend>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="tipo_visita" class="form-label small">Tipo de Visita</label>
                            <select id="tipo_visita" name="tipo_visita" class="form-select">
                                {% set tv = pedido.tipo_visita or '' %}
                                <option value="Monitoramento" {% if tv == 'Monitoramento' %}selected{% endif %}>Monitoramento</option>
                                <option value="Aedes Aegypti" {% if tv == 'Aedes Aegypti' %}selected{% endif %}>Aedes Aegypti</option>
                                <option value="Culex" {% if tv == 'Culex' %}selected{% endif %}>Culex</option>                            
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="altura_voo" class="form-label small">Altura M√°xima do Voo</label>
                            <select id="altura_voo" name="altura_voo" class="form-select">
                                {% set av = pedido.altura_voo or '' %}
                                <option value="10m" {% if av == '10m' %}selected{% endif %}>10m</option>
                                <option value="20m" {% if av == '20m' %}selected{% endif %}>20m</option>
                                <option value="30m" {% if av == '30m' %}selected{% endif %}>30m</option>
                                <option value="40m" {% if av == '40m' %}selected{% endif %}>40m</option>                            
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label small">Risco Adicional</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="criadouro" value="sim" id="criadouro" 
                                    {% if pedido.criadouro %}checked{% endif %}>
                                <label class="form-check-label small" for="criadouro">
                                    Identifica√ß√£o de Criadouro?
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="apoio_cet" value="sim" id="apoio_cet" 
                                    {% if pedido.apoio_cet %}checked{% endif %}>
                                <label class="form-check-label small" for="apoio_cet">
                                    Necessita de Apoio CET?
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label for="observacao" class="form-label small">Observa√ß√µes da UVIS</label>
                        <textarea class="form-control" id="observacao" name="observacao" rows="2" 
                            placeholder="Informa√ß√µes adicionais fornecidas pela UVIS.">{{ pedido.observacao or '' }}</textarea>
                    </div>
                </fieldset>

                {# --- SE√á√ÉO 3: ENDERE√áO E GPS --- #}
                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 small fw-bold">3. Localiza√ß√£o</legend>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="cep" class="form-label small">CEP</label>
                            <input type="text" class="form-control" id="cep" name="cep" 
                                value="{{ pedido.cep or '' }}" required>
                        </div>
                        <div class="col-md-7">
                            <label for="logradouro" class="form-label small">Logradouro</label>
                            <input type="text" class="form-control" id="logradouro" name="logradouro" 
                                value="{{ pedido.logradouro or '' }}" required>
                        </div>
                        <div class="col-md-2">
                            <label for="numero" class="form-label small">N√∫mero</label>
                            <input type="text" class="form-control" id="numero" name="numero" 
                                value="{{ pedido.numero or '' }}" placeholder="S/N">
                        </div>
                        <div class="col-md-5">
                            <label for="bairro" class="form-label small">Bairro</label>
                            <input type="text" class="form-control" id="bairro" name="bairro" 
                                value="{{ pedido.bairro or '' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="cidade" class="form-label small">Cidade</label>
                            <input type="text" class="form-control" id="cidade" name="cidade" 
                                value="{{ pedido.cidade or '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label for="uf" class="form-label small">UF</label>
                            <input type="text" class="form-control" id="uf" name="uf" 
                                value="{{ pedido.uf or '' }}" maxlength="2" required>
                        </div>
                        <div class="col-12">
                            <label for="complemento" class="form-label small">Complemento</label>
                            <input type="text" class="form-control" id="complemento" name="complemento" 
                                value="{{ pedido.complemento or '' }}" placeholder="Ex: Fundos, Bloco B">
                        </div>
                    </div>
                    
                    <h6 class="small mt-4">Geolocaliza√ß√£o (Lat/Long)</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input name="latitude" class="form-control form-control-sm font-monospace" placeholder="Latitude" 
                                value="{{ pedido.latitude or '' }}">
                        </div>
                        <div class="col-md-6">
                            <input name="longitude" class="form-control form-control-sm font-monospace" placeholder="Longitude" 
                                value="{{ pedido.longitude or '' }}">
                        </div>
                    </div>
                </fieldset>

                {# --- SE√á√ÉO 4: PROTOCOLO E STATUS (ADMIN) --- #}
                <fieldset class="mb-4 p-3 border rounded">
                    <legend class="float-none w-auto px-2 small fw-bold">4. Status e Decis√£o (Controle Interno)</legend>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="protocolo" class="form-label small">Protocolo DECEA</label>
                            <input name="protocolo" class="form-control form-control-sm font-monospace" id="protocolo" 
                                placeholder="BR-2025-XXXX" value="{{ pedido.protocolo or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label small">Status</label>
                            <select name="status" id="status" class="form-select form-select-sm">
                                {% set status = pedido.status or 'PENDENTE' %}
                                <option value="PENDENTE" {% if status=='PENDENTE' %}selected{% endif %}>‚ö™Ô∏è Pendente</option>
                                <option value="EM AN√ÅLISE" {% if status=='EM AN√ÅLISE' %}selected{% endif %}>üü° Em An√°lise</option>
                                <option value="APROVADO" {% if status=='APROVADO' %}selected{% endif %}>üü¢ APROVADO</option>
                                <option value="NEGADO" {% if status=='NEGADO' %}selected{% endif %}>üî¥ NEGADO</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="justificativa" class="form-label small">Justificativa (Se Negado/Observa√ß√µes)</label>
                            <input name="justificativa" class="form-control form-control-sm" id="justificativa" 
                                value="{{ pedido.justificativa or '' }}">
                        </div>
                    </div>
                </fieldset>

                <div class="d-flex justify-content-between pt-3">
                    <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg fw-bold">
                        <i class="bi bi-floppy"></i> Salvar Todas as Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}