{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-secondary">
        <i class="bi bi-list-task"></i> Minhas Solicita칞칫es
    </h2>
    <a href="{{ url_for('main.novo') }}" class="btn btn-success shadow-sm">
        <i class="bi bi-plus-lg"></i> Nova Solicita칞칚o
    </a>
</div>

<form method="GET" class="card p-3 mb-4 shadow-sm border-0">
    <div class="row g-2 align-items-end">
        <div class="col-md-5">
            <label class="small text-muted fw-bold mb-1">Filtrar por Situa칞칚o</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">Todos os Pedidos</option>
                <option value="PENDENTE" {{ 'selected' if request.args.get('status')=='PENDENTE' else '' }}>丘쀮잺 Pendentes</option>
                <option value="EM AN츼LISE" {{ 'selected' if request.args.get('status')=='EM AN츼LISE' else '' }}>游리 Em An치lise</option>
                <option value="APROVADO" {{ 'selected' if request.args.get('status')=='APROVADO' else '' }}>游릭 Aprovados</option>
                <option value="NEGADO" {{ 'selected' if request.args.get('status')=='NEGADO' else '' }}>游댮 Negados</option>
            </select>
        </div>
        
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="bi bi-funnel me-2"></i> Filtrar
            </button>
        </div>

        {% if request.args.get('status') %}
        <div class="col-md-2">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary btn-sm w-100">
                <i class="bi bi-x-lg"></i> Limpar
            </a>
        </div>
        {% endif %}
    </div>
</form>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data Planejada</th>
                        <th style="width: 45%">Localiza칞칚o / Motivo</th>
                        <th class="text-center">Situa칞칚o</th>
                        <th>Protocolo DECEA</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in solicitacoes %}
                    <tr>
                        <td>
                            <strong class="text-dark">
                                {{ p.data_agendamento[8:10] }}-{{ p.data_agendamento[5:7] }}-{{ p.data_agendamento[2:4] }}
                            </strong>
                            <br />
                            <small class="text-muted">{{ p.hora_agendamento }}</small>
                        </td>

                        <td>
                            <div class="d-flex flex-column">
                                {% if p.logradouro %}
                                    <span class="fw-bold text-dark">
                                        {{ p.logradouro }}, {{ p.numero or 'S/N' }}
                                    </span>
                                    <small class="text-muted">
                                        {{ p.bairro }} - {{ p.cidade }}/{{ p.uf }}
                                    </small>
                                {% else %}
                                    <span class="fw-bold text-dark">
                                        {{ p.endereco or 'Endere칞o n칚o informado' }}
                                    </span>
                                {% endif %}

                                <div class="mt-1">
                                    <span class="badge bg-light text-dark border">{{ p.foco }}</span>
                                </div>
                            </div>
                        </td>

                        <td class="text-center">
                            {% if p.status == 'PENDENTE' %}
                                <span class="badge bg-secondary text-white">
                                    <i class="bi bi-hourglass me-1"></i> Pendente
                                </span>

                            {% elif p.status == 'APROVADO' %}
                                <span class="badge bg-success rounded-pill">
                                    <i class="bi bi-check-lg me-1"></i> Aprovado
                                </span>

                            {% elif p.status == 'NEGADO' %}
                                <span class="badge bg-danger rounded-pill" data-bs-toggle="tooltip" title="{{ p.justificativa }}">
                                    <i class="bi bi-x-circle me-1"></i> Negado
                                </span>
                                <div class="small text-danger mt-1 fw-bold" style="cursor: help; font-size: 0.75rem" data-bs-toggle="tooltip" title="{{ p.justificativa }}">
                                    Ver Motivo
                                </div>

                            {% else %}
                                <span class="badge bg-warning text-dark rounded-pill">Em An치lise</span>
                            {% endif %}
                        </td>

                        <td class="font-monospace text-primary fw-bold">
                            {{ p.protocolo or '-' }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            <p>Nenhuma solicita칞칚o encontrada com esse status.</p>
                            {% if request.args.get('status') %}
                                <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-primary">Ver Todos</a>
                            {% else %}
                                <a href="{{ url_for('main.novo') }}" class="btn btn-sm btn-primary">Criar Agora</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if paginacao and paginacao.pages > 1 %}
<nav aria-label="Navega칞칚o de p치ginas" class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
            <a class="page-link" 
               href="{{ url_for('main.dashboard', 
                           page=paginacao.prev_num, 
                           status=request.args.get('status', '')) }}">
                Anterior
            </a>
        </li>

        {% for p in paginacao.iter_pages() %}
            {% if p %}
                {% if p == paginacao.page %}
                <li class="page-item active" aria-current="page"><a class="page-link">{{ p }}</a></li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" 
                       href="{{ url_for('main.dashboard', 
                                   page=p, 
                                   status=request.args.get('status', '')) }}">
                        {{ p }}
                    </a>
                </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><a class="page-link">...</a></li>
            {% endif %}
        {% endfor %}
        
        <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
            <a class="page-link" 
               href="{{ url_for('main.dashboard', 
                           page=paginacao.next_num, 
                           status=request.args.get('status', '')) }}">
                Pr칩xima
            </a>
        </li>
    </ul>
</nav>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>

{% endblock %}