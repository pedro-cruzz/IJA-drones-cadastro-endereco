{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark"><i class="bi bi-shield-lock-fill"></i> Painel de Gest칚o</h2>

    {# 1. CONTROLE DE PERMISS츾O: BOT칏ES EXPORTAR #}
    <div class="d-flex gap-2">
        {% if is_editable %}
        {# MANTIDO: BOT츾O EXPORTAR EXCEL (Permitido para ADMIN e OPERARIO) #}
        <a class="btn btn-success" href="{{ url_for('main.exportar_excel',
            status=request.args.get('status'),
            unidade=request.args.get('unidade'),
            regiao=request.args.get('regiao')
        ) }}">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar Excel
        </a>
        {% endif %}

        {# REMOVIDO: O bloco de exportar PDF que causava o erro 'now() is undefined' #}
    </div>
</div>

{# --- Formul치rio de Filtros --- #}
<form method="GET" class="card p-3 mb-4 shadow-sm">
    <div class="row g-2">
        <div class="col-md-3">
            <label class="small text-muted">Filtrar por Status</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">Todos</option>
                <option value="PENDENTE" {{ 'selected' if request.args.get('status')=='PENDENTE' else '' }}>丘쀮잺 Pendente</option>
                <option value="EM AN츼LISE" {{ 'selected' if request.args.get('status')=='EM AN츼LISE' else '' }}>游리 Em An치lise</option>
                <option value="APROVADO" {{ 'selected' if request.args.get('status')=='APROVADO' else '' }}>游릭 Aprovado</option>
                <option value="NEGADO" {{ 'selected' if request.args.get('status')=='NEGADO' else '' }}>游댮 Negado</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="small text-muted color-light" >Pesquisar por Unidade</label>
            <input type="text" name="unidade" class="text-add form-control form-control-sm" placeholder="Nome da UVIS..." value="{{ request.args.get('unidade', '') }}">
        </div>
        <div class="col-md-3">
            <label class="small text-muted">Regi칚o</label>
            <input type="text" name="regiao" class="text-add form-control form-control-sm" placeholder="Leste, Oeste..." value="{{ request.args.get('regiao', '') }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-dark btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
    </div>
</form>

{# --- Tabela de Pedidos --- #}
<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th style="width: 25%">Unidade</th>
                    <th style="width: 40%">Dados da Opera칞칚o</th>
                    {# AJUSTE DO HEADER PARA REFLETIR O TIPO DE USU츼RIO #}
                    <th style="width: 35%">{% if is_editable %}Decis칚o & Ajustes{% else %}Status Atual & Protocolo{% endif %}</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pedidos %}
                {# **LINHA CORRIGIDA: REMOVIDA A TAG <form> EXTERNA** #}
                <tr>
                    <td class="align-top pt-3">
                        <strong class="text-primary fs-6">{{ p.autor.nome_uvis }}</strong>
                        <br>
                        <span class="badge bg-secondary mb-2 mt-1">{{ p.autor.regiao }}</span>

                        
                        <div class="small text-muted border-top pt-2 mt-2">
                            <i class="bi bi-calendar"></i> 
                            {{ p.data_agendamento.strftime('%d/%m/%Y') }} 맙 {{ p.hora_agendamento.strftime('%H:%M') }} 
                            <br><br>

                            <i class="bi bi-geo-alt"></i>
                            {{ p.logradouro }}, {{ p.numero or 'S/N' }}
                            {% if p.complemento %} <br><span class="fst-italic">({{ p.complemento }})</span> {% endif %}
                            <br>
                            {{ p.bairro }} - {{ p.cidade }}/{{ p.uf }}
                            <br>
                            CEP: {{ p.cep }}
                        </div>
                        {# NOVO: BOT칏ES DE ADMIN/DELETAR #}
                        {% if current_user.tipo_usuario == 'admin' %}
                        <div class="d-flex gap-1 mt-2">
                            <a href="{{ url_for('main.admin_editar', id=p.id) }}" class="btn btn-sm btn-success">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                            {# ESTE FORMUL츼RIO EST츼 CORRETO E AGORA N츾O EST츼 ANINHADO #}
                            <form class="form-deletar" action="{{ url_for('main.deletar_registro', id=p.id) }}" method="POST">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Deletar
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        {# FIM NOVO BOT칏ES DE ADMIN/DELETAR #}

                    </td>

                    <td class="align-top pt-3">
                        {# Dados da Opera칞칚o - GPS #}
                        {% if p.latitude and p.longitude %}
                        <div class="d-flex justify-content-between align-items-center p-2 rounded mb-3 border">
                            <div style="line-height: 1.2;">
                                <small class="text-muted d-block">GPS:</small>
                                <small class="fw-bold font-monospace">{{ p.latitude }}, {{ p.longitude }}</small>
                            </div>
                            {# Aten칞칚o: Mapeamento corrigido. Use http://maps.google.com/maps?q=... #}
                            <a href="http://maps.google.com/maps?q={{ p.latitude }},{{ p.longitude }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-map-fill"></i> Mapa
                            </a>
                        </div>
                        {% else %}
                        <div class="alert alert-warning py-1 px-2 small mb-3">
                            <i class="bi bi-exclamation-triangle"></i> Sem coordenadas
                        </div>
                        {% endif %}

                        {# Dados da Opera칞칚o - Detalhes #}
                        <div class="row g-2 small mb-2">
                            <div class="col-6">
                                <span class="text-muted d-block">Tipo de Visita:</span>
                                <strong class="text-capitalize">{{ p.tipo_visita or '--' }}</strong>
                            </div>
                            <div class="col-6">
                                <span class="text-muted d-block">Altura Voo:</span>
                                <strong>{{ p.altura_voo or '--' }}</strong>
                            </div>
                            <div class="col-12">
                                <span class="text-muted d-block">Foco:</span>
                                <strong>{{ p.foco }}</strong>
                            </div>
                        </div>

                        <div class="mb-3">
                            {% if p.criadouro %}
                            <span class="badge bg-danger">Criadouro: SIM</span>
                            {% else %}
                            <span class="badge bg-light text-secondary border">Criadouro: N츾O</span>
                            {% endif %}

                            {% if p.apoio_cet %}
                            <span class="badge bg-warning text-dark">Apoio CET: SIM</span>
                            {% else %}
                            <span class="badge bg-light text-secondary border">Apoio CET: N츾O</span>
                            {% endif %}
                        </div>

                        {% if p.observacao %}
                        <div class="p-2 border rounded small fst-italic text-muted campo-observacao"> 
                            <i class="bi bi-chat-quote me-1"></i> "{{ p.observacao }}"
                        </div>
                        {% endif %}
                    </td>

                    <td class="align-top pt-3 bg-opacity-50">
                        
                        {# **LINHA CORRIGIDA: O FORMUL츼RIO DE ATUALIZA칂츾O COME칂A AQUI** #}
                        {% if is_editable %}
                        <form action="{{ url_for('main.atualizar', id=p.id) }}" method="POST">
                            <div class="row g-1 mb-2">
                                <div class="col-12"><label class="small fw-bold text-muted">Ajuste GPS (Lat / Long)</label></div>
                                <div class="col-6">
                                    <input name="latitude" class="form-control form-control-sm font-monospace" placeholder="Lat" value="{{ p.latitude or '' }}">
                                </div>
                                <div class="col-6">
                                    <input name="longitude" class="form-control form-control-sm font-monospace" placeholder="Long" value="{{ p.longitude or '' }}">
                                </div>
                            </div>

                            <label class="small fw-bold text-muted">Protocolo DECEA</label>
                            <input name="protocolo" class="form-control form-control-sm font-monospace mb-2" placeholder="BR-2025-XXXX" value="{{ p.protocolo or '' }}">

                            <div class="p-2 border rounded">
                                <label class="small fw-bold text-muted">Status</label>
                                <select name="status" class="form-select form-select-sm mb-2">
                                    <option value="PENDENTE" {% if p.status=='PENDENTE' %}selected{% endif %}>丘쀮잺 Pendente</option>
                                    <option value="EM AN츼LISE" {% if p.status=='EM AN츼LISE' %}selected{% endif %}>游리 Em An치lise</option>
                                    <option value="APROVADO" {% if p.status=='APROVADO' %}selected{% endif %}>游릭 APROVAR</option>
                                    <option value="NEGADO" {% if p.status=='NEGADO' %}selected{% endif %}>游댮 NEGAR</option>
                                </select>

                                <label class="small fw-bold text-muted">Justificativa (se negar)</label>
                                <input name="justificativa" class="form-control form-control-sm mb-2" value="{{ p.justificativa or '' }}">

                                <button class="btn btn-primary btn-sm w-100 fw-bold">
                                    <i class="bi bi-check-lg"></i> Salvar Decis칚o
                                </button>
                            </div>
                        </form>
                        {# **LINHA CORRIGIDA: O FORMUL츼RIO DE ATUALIZA칂츾O TERMINA AQUI** #}
                        
                        {# CONTE칔DO SOMENTE LEITURA PARA 'VISUALIZAR' #}
                        {% else %}
                        
                        <div class="p-3 border rounded bg-white">
                            <label class="small fw-bold text-muted">Status Atual:</label>
                            <div class="text-center mb-3">
                                <span class="badge 
                                    {% if p.status=='PENDENTE' %}bg-secondary{% elif p.status=='EM AN츼LISE' %}bg-warning text-dark{% elif p.status=='APROVADO' %}bg-success{% elif p.status=='NEGADO' %}bg-danger{% endif %} 
                                    fs-6 p-2">
                                    {{ p.status }}
                                </span>
                            </div>

                            <label class="small fw-bold text-muted">Protocolo DECEA:</label>
                            <div class="mb-2 p-1 border rounded font-monospace small">
                                {{ p.protocolo or 'N/A' }}
                            </div>

                            <label class="small fw-bold text-muted">Justificativa (se houver):</label>
                            <div class="small p-1 border rounded fst-italic text-muted">
                                {{ p.justificativa or 'Nenhuma' }}
                            </div>
                        </div>
                        
                        {% endif %}
                    </td>
                </tr>
                {# **LINHA CORRIGIDA: REMOVIDA A TAG </form> EXTERNA FINAL** #}
                {% else %}
                <tr>
                    <td colspan="3" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Nenhum pedido encontrado.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {# --- Pagina칞칚o --- #}
        {% if paginacao.pages > 1 %}
        <nav aria-label="Navega칞칚o" class="mt-4 pb-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.prev_num, status=request.args.get('status'), unidade=request.args.get('unidade'), regiao=request.args.get('regiao')) }}">Anterior</a>
                </li>
                <li class="page-item disabled"><a class="page-link">P치gina {{ paginacao.page }} de {{ paginacao.pages }}</a></li>
                <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.next_num, status=request.args.get('status'), unidade=request.args.get('unidade'), regiao=request.args.get('regiao')) }}">Pr칩xima</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>


{% block scripts %}
<script>
document.querySelectorAll('.form-deletar').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        Swal.fire({
            title: 'Tem certeza?',
            text: "Voc칡 est치 prestes a DELETAR PERMANENTEMENTE este registro.",
            icon: 'warning',
            customClass: 'swal-sm',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, deletar!',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}



{% endblock %}